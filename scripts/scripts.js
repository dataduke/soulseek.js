"use strict";angular.module("p2pmusicApp",[]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),function(){function e(e,n){function o(o){function t(n){"one-to-one"===e.direction&&window.isFirstConnectionOpened||(n?(C.offerSDP=n,C.onAnswerSDP=c):C.onOfferSDP=c,v=i(C))}function s(t){t.peer=v.peer,f[f.length]=t,n.onopen(o.userid,t),"many-to-many"===e.direction&&l&&u.split("--").length>3&&p&&p.send({newParticipant:w.channel,userToken:a.userToken}),window.isFirstConnectionOpened=h=!0}function c(e){console.log(e),e=JSON.stringify(e);var n=parseInt(e.length/3),o=e.slice(0,n),t=e.slice(n,e.length-1),i="";e.length>n+n&&(t=e.slice(n,n+n),i=e.slice(n+n,e.length)),w.send({userToken:a.userToken,firstPart:o}),w.send({userToken:a.userToken,secondPart:t}),w.send({userToken:a.userToken,thirdPart:i})}function d(n){n.userToken!=a.userToken&&((n.firstPart||n.secondPart||n.thirdPart)&&(n.firstPart&&(o.userid=n.userToken,S.firstPart=n.firstPart,S.secondPart&&S.thirdPart&&m()),n.secondPart&&(S.secondPart=n.secondPart,S.firstPart&&S.thirdPart&&m()),n.thirdPart&&(S.thirdPart=n.thirdPart,S.firstPart&&S.secondPart&&m())),n.candidate&&!h&&(v&&v.addICE({sdpMLineIndex:n.candidate.sdpMLineIndex,candidate:JSON.parse(n.candidate.candidate)}),console.debug("ice candidate",n.candidate.candidate)),n.left&&(v&&v.peer&&(v.peer.close(),v.peer=null),n.closeEntireSession?r():w&&(w.send({left:!0,userToken:a.userToken}),w=null),e.onleave(n.userToken)),n.playRoleOfBroadcaster&&setTimeout(function(){a.roomToken=n.roomToken,e.open(a.roomToken),a.sockets=a.sockets.swap()},600))}function m(){T||(T=!0,S.sdp=JSON.parse(S.firstPart+S.secondPart+S.thirdPart),k?v.addAnswerSDP(S.sdp):t(S.sdp),console.debug("sdp",S.sdp.sdp))}var g={channel:o.channel,onmessage:d,onopen:function(){k&&!v&&t(),o.socketIndex=w.index=a.sockets.length,a.socketObjects[g.channel]=w,a.sockets[o.socketIndex]=w}};g.callback=function(e){w=e,g.onopen()};var h,v,w=e.openSignalingChannel(g),k=o.isofferer,S={},C={onICE:function(e){w&&w.send({userToken:a.userToken,candidate:{sdpMLineIndex:e.sdpMLineIndex,candidate:JSON.stringify(e.candidate)}})},onopen:s,onmessage:function(e){n.onmessage(e.data,o.userid)},onclose:n.onclose,onerror:e.onerror},T=!1}function t(e){if(e&&-1==u.indexOf(e)&&e!=a.userToken){u+=e+"--";var n=s();o({channel:n,closeSocket:!0}),p.send({participant:!0,userToken:a.userToken,joinUser:e,channel:n})}}function s(){return(Math.random()*(new Date).getTime()).toString(36).toUpperCase().replace(/\./g,"-")}function r(n){var o={left:!0,userToken:a.userToken};if(l&&(e.autoCloseEntireSession?o.closeEntireSession=!0:a.sockets[0].send({playRoleOfBroadcaster:!0,userToken:a.userToken,roomToken:a.roomToken})),!n){for(var t=a.sockets,i=t.length,s=0;i>s;s++){var r=t[s];r&&(r.send(o),a.socketObjects[r.channel]&&delete a.socketObjects[r.channel],delete t[s])}c.left=!0}n&&(r=a.socketObjects[n],r&&(r.send(o),a.sockets[r.index]&&delete a.sockets[r.index],delete a.socketObjects[n])),a.sockets=a.sockets.swap()}var a={},c=this;a.userToken=e.userid||s(),a.sockets=[],a.socketObjects={};var l,u="--",d=!0,f=[];window.onunload=function(){r()};var p=e.openSignalingChannel({onmessage:function(e){e.userToken!=a.userToken&&(d&&e.roomToken&&e.broadcaster&&n.onroom(e),e.newParticipant&&t(e.newParticipant),e.userToken&&e.joinUser==a.userToken&&e.participant&&-1==u.indexOf(e.userToken)&&(u+=e.userToken+"--",console.debug("Data connection is being opened between you and",e.userToken||e.channel),o({isofferer:!0,channel:e.channel||e.userToken,closeSocket:!0})))},callback:function(e){p=e}});return{createRoom:function(){a.roomToken=s(),l=!0,d=!1,function n(){p&&p.send({roomToken:a.roomToken,broadcaster:a.userToken}),e.transmitRoomOnce||c.leaving||("one-to-one"===e.direction?window.isFirstConnectionOpened||setTimeout(n,3e3):setTimeout(n,3e3))}()},joinRoom:function(e){a.roomToken=e.roomToken,d=!1,o({channel:a.userToken}),p.send({participant:!0,userToken:a.userToken,joinUser:e.joinUser})},send:function(e,n){var o,t=f,i=t.length;if(i)if(o=moz&&e.file?e.file:JSON.stringify(e),n)n.send(o);else for(var s=0;i>s;s++)t[s].send(o)},leave:function(n,o){o&&(e.autoCloseEntireSession=!0),r(n),n||(a.joinedARoom=l=!1,d=!0)}}}function n(e,n){var o=n.openSocket({channel:e,onopen:n.onopen,onmessage:n.onmessage});return{send:function(e){o&&o.send({userid:userid,message:e})}}}function o(){function e(e,s){if(moz&&(e.fileName&&(o=e.fileName),e.size)){var a=new window.FileReader;a.readAsDataURL(e),a.onload=function(e){r.SaveToDisk(e.target.result,o),s.onFileReceived&&s.onFileReceived(o)}}moz||(e.packets&&(i=t=parseInt(e.packets)),s.onFileProgress&&s.onFileProgress({fileName:e.name,remaining:t--,length:i,received:i-t}),n.push(e.message),e.last&&(r.SaveToDisk(n.join(""),e.name),s.onFileReceived&&s.onFileReceived(e.name),n=[]))}var n=[],o="",t=0,i=0;return{receive:e}}function t(){function e(e,o,t){n.push(e.message),e.last&&(n=n.join(""),e.isobject&&(n=JSON.parse(n)),o&&o(n,t),n=[])}var n=[];return{receive:e}}function i(e){function n(n){n.candidate&&g&&e.onICE&&e.onICE(n.candidate)}function o(){e.onOfferSDP&&g.createOffer(function(n){g.setLocalDescription(n),e.onOfferSDP(n)},null,h)}function t(){e.onAnswerSDP&&(e.offerSDP=new d(e.offerSDP),g.setRemoteDescription(e.offerSDP),g.createAnswer(function(n){g.setLocalDescription(n),e.onAnswerSDP(n)},null,h))}function i(){(!moz||e.onOfferSDP)&&(s(),moz&&navigator.mozGetUserMedia({audio:!0,fake:!0},function(e){g.addStream(e),o()},c))}function s(){v=g.createDataChannel(e.channel||"RTCDataChannel",moz?{}:{reliable:!1}),moz&&(v.binaryType="blob"),r()}function r(){v.onmessage=e.onmessage,v.onopen=function(){e.onopen(v)},v.onclose=e.onclose,v.onerror=e.onerror}function a(){g.ondatachannel=function(e){v=e.channel,v.binaryType="blob",r()},moz&&navigator.mozGetUserMedia({audio:!0,fake:!0},function(e){g.addStream(e),t()},c)}function c(){}var l=window,u=l.mozRTCPeerConnection||l.webkitRTCPeerConnection,d=l.mozRTCSessionDescription||l.RTCSessionDescription,f=l.mozRTCIceCandidate||l.RTCIceCandidate,p={iceServers:[{url:moz?"stun:23.21.150.121":"stun:stun.l.google.com:19302"}]},m={optional:[]};moz||(m.optional=[{RtpDataChannels:!0}]);var g=new u(p,m);i(),g.onicecandidate=n;var h=e.constraints||{optional:[],mandatory:{OfferToReceiveAudio:!!moz,OfferToReceiveVideo:!!moz}};moz||(o(),t());var v;return e.onAnswerSDP&&moz&&a(),{addAnswerSDP:function(e){e=new d(e),g.setRemoteDescription(e)},addICE:function(e){g.addIceCandidate(new f({sdpMLineIndex:e.sdpMLineIndex,candidate:e.candidate}))},peer:g,channel:v,sendData:function(e){v&&v.send(e)}}}window.DataChannel=function(i,r){function c(e){for(var n in r)p[n]=r[n];if(p.direction=p.direction||"many-to-many",p.userid&&(window.userid=p.userid),p.openSignalingChannel)e();else if(void 0===p.transmitRoomOnce&&(p.transmitRoomOnce=!0),p.openSignalingChannel=function(e){e=e||{},i=e.channel||p.channel||"default-channel";var n=new window.Firebase("https://"+(p.firebase||"chat")+".firebaseIO.com/"+i);return n.channel=i,n.on("child_added",function(n){e.onmessage(n.val())}),n.send=function(e){this.push(e)},p.socket||(p.socket=n),(i!=p.channel||p.isInitiator&&i==p.channel)&&n.onDisconnect().remove(),e.onopen&&setTimeout(e.onopen,1),n},window.Firebase)e();else{var o=document.createElement("script");o.src="https://cdn.firebase.com/v0/firebase.js",o.onload=e,document.documentElement.appendChild(o)}}function l(){p.config||(p.config={onroom:function(e){return u?(p.joinedARoom||(p.joinedARoom=!0,u.joinRoom({roomToken:e.roomToken,joinUser:e.broadcaster})),void 0):(p.room=e,void 0)},onopen:function(e,n){p.onopen(e,n),p.channels[e]={channel:n,send:function(e){p.send(e,this.channel)}}},onmessage:function(e,n){if(IsDataChannelSupported&&!e.size&&(e=JSON.parse(e)),!IsDataChannelSupported){if(e.userid===window.userid)return;e=e.message}"text"===e.type?f.receive(e,p.onmessage,n):e.size||"file"===e.type?d.receive(e,p):p.onmessage(e,n)},onclose:function(e){var n=p.channels,o=e.currentTarget;for(var t in n)o===n[t].channel&&delete n[t];p.onclose(e)}},u=IsDataChannelSupported?new e(p,p.config):new n(p.channel,p.config),d=new o,f=new t,p.room&&p.config.onroom(p.room))}i&&(this.automatic=!0),this.channel=i,r=r||{};var u,d,f,p=this;this.onmessage=function(e,n){console.debug(n,"sent message:",e)},this.channels={},this.onopen=function(e){console.debug(e,"is connected with you.")},this.onclose=function(e){console.error("data channel closed:",e)},this.onerror=function(e){console.error("data channel error:",e)},this.onFileReceived=function(e){console.debug("File <",e,"> received successfully.")},this.onFileSent=function(e){console.debug("File <",e.name,"> sent successfully.")},this.onFileProgress=function(e){console.debug("<",e.remaining,"> items remaining.")},this.open=function(e){p.joinedARoom=!0,p.socket?p.socket.onDisconnect().remove():p.isInitiator=!0,e&&(p.channel=e),c(function(){l(),IsDataChannelSupported&&u.createRoom()})},this.connect=function(e){e&&(p.channel=e),c(l)},this.send=function(e,n){if(!e)throw"No file, data or text message to share.";e.size?s.send({file:e,channel:u,onFileSent:function(e){p.onFileSent(e)},onFileProgress:function(e){p.onFileProgress(e)},_channel:n}):a.send({text:e,channel:u,_channel:n})},this.onleave=function(e){console.debug(e,"left!")},this.leave=this.eject=function(e){u.leave(e,p.autoCloseEntireSession)},this.openNewSession=function(e,n){if(e){if(p.isNewSessionOpened)return;p.isNewSessionOpened=!0,p.joinedARoom||p.open()}(!e||n)&&p.connect(),n&&setTimeout(function(){p.openNewSession(!0)},5e3)},p.automatic&&(window.Firebase?(console.debug("checking presence of the room.."),new window.Firebase("https://"+(r.firebase||p.firebase||"chat")+".firebaseIO.com/"+p.channel).once("value",function(e){console.debug("room is present?",null!=e.val()),p.openNewSession(null==e.val())})):p.openNewSession(!1,!0))},window.userid=(Math.random()*(new Date).getTime()).toString(36).toUpperCase().replace(/\./g,"-");var s={send:function(e){function n(s,u){var d={type:"file",name:i.name};s&&(u=s.target.result,c=l=d.packets=parseInt(u.length/r)),e.onFileProgress&&e.onFileProgress({fileName:i.name,remaining:l--,length:c,sent:c-l}),u.length>r?d.message=u.slice(0,r):(d.message=u,d.last=!0,d.name=i.name,e.onFileSent&&e.onFileSent(i)),o.send(d,t),a=u.slice(d.message.length),a.length&&setTimeout(function(){n(null,a)},10)}var o=e.channel,t=e._channel,i=e.file;if(moz&&IsDataChannelSupported&&(o.send({fileName:i.name,type:"file"},t),o.send({file:i},t),e.onFileSent&&e.onFileSent(i)),!IsDataChannelSupported||!moz){var s=new window.FileReader;s.readAsDataURL(i),s.onload=n}var r=1e3,a="",c=0,l=0}},r={SaveToDisk:function(e,n){var o=document.createElement("a");o.href=e,o.target="_blank",o.download=n||e;var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),o.dispatchEvent(t),(window.URL||window.webkitURL).revokeObjectURL(o.href)}},a={send:function(e){function n(e,i){var c={type:"text"};e&&(i=e,c.packets=parseInt(i.length/s)),i.length>s?c.message=i.slice(0,s):(c.message=i,c.last=!0,c.isobject=a),o.send(c,t),r=i.slice(c.message.length),r.length&&setTimeout(function(){n(null,r)},50)}var o=e.channel,t=e._channel,i=e.text,s=1e3,r="",a=!1;"string"!=typeof i&&(a=!0,i=JSON.stringify(i)),IsDataChannelSupported&&(moz||s>=i.length)?o.send(e.text,t):n(i)}};Array.prototype.swap=function(){for(var e=[],n=this,o=n.length,t=0;o>t;t++)n[t]&&(e[e.length]=n[t]);return e},window.moz=!!navigator.mozGetUserMedia,window.IsDataChannelSupported=!(moz&&!navigator.mozGetUserMedia||!moz&&!navigator.webkitGetUserMedia)}(),angular.module("p2pmusicApp").factory("RTCService",["$rootScope","fileService","playerService",function(e,n,o){window.mainChannel={};var t=function(t){window.mainChannel=new DataChannel("slsk-channel",{direction:"many-to-many",autoCloseEntireSession:!1,transmitRoomOnce:!1,userid:t,onopen:function(n){e.$broadcast("rtc-onopen",n)},onleave:function(n){e.$broadcast("rtc-onleave",n)},onmessage:function(o,t){if("object"==typeof o){if(console.log(o),void 0!==o.filelistRequest&&mainChannel.channels[t].send({filelist:n.ownFiles.map(function(e){return e.fullPath})}),void 0!==o.filelist&&(mainChannel.channels[t].filelist=o.filelist,e.$broadcast("rtc-gotFileList",{files:o.filelist,userid:t})),void 0!==o.requestFile){var i=ownFiles.filter(function(e){return e.fullPath==o.requestFile});i[0].file(function(e){mainChannel.channels[t].send(e)})}if(void 0!==o.requestStream){var i=ownFiles.filter(function(e){return e.fullPath==o.requestFile});i[0].file(function(){new window.FileReader,reader.readAsArrayBuffer(result),reader.onload=function(){mainChannel.channels[t].send(reader.result)}})}}else"string"==typeof o&&e.$broadcast("rtc-onmessage",{msg:o,user:t})},onFileProgress:function(n){e.$broadcast("rtc-onFileProgress",n)},onStreamProgress:function(e){console.log(e),o.bufferSound(e)},onFileSent:function(n){e.$broadcast("rtc-onFileSent",n)},onFileReceived:function(n){console.log(n),e.$broadcast("rtc-onFileReceived",n)}})};return{mainChannel:mainChannel,setupDataChannel:t}}]),angular.module("p2pmusicApp").factory("fileService",["$rootScope",function(e){function n(e,n){var o=document.querySelector(e);this.dragenter=function(e){e.stopPropagation(),e.preventDefault(),o.classList.add("dropping")},this.dragover=function(e){e.stopPropagation(),e.preventDefault()},this.dragleave=function(e){e.stopPropagation(),e.preventDefault()},this.drop=function(e){e.stopPropagation(),e.preventDefault(),o.classList.remove("dropping"),n(e.dataTransfer.files,e)},o.addEventListener("dragenter",this.dragenter,!1),o.addEventListener("dragover",this.dragover,!1),o.addEventListener("dragleave",this.dragleave,!1),o.addEventListener("drop",this.drop,!1)}var o=new n("body",function(n,o){var i=o.dataTransfer.items;t(i,function(n){e.$broadcast("file-Drop",n)})});window.ownFiles=[];var t=function(e,n){for(var e=e,o=function(e){console.log(e)},t=function(e){if(e.isDirectory){var n=e.createReader();n.readEntries(function(e){for(var n=0;e.length>n;++n)t(e[n])},o)}else ownFiles.push(e)},i=0;e.length>i;++i)t(e[i].webkitGetAsEntry());n(ownFiles)};return{dnd:o,dirRead:t,ownFiles:ownFiles}}]),angular.module("p2pmusicApp").controller("MainCtrl",["$scope","fileService","RTCService",function(){}]),angular.module("p2pmusicApp").controller("PeersCtrl",["$scope","$rootScope",function(e,n){e.peers=["You"],e.showFileList=function(){mainChannel.channels[this.peer].send({filelistRequest:!0})},n.$on("rtc-onopen",function(n,o){e.peers.push(o),e.$digest()}),n.$on("rtc-onleave",function(n,o){for(var t=0;e.peers.length>t;t++){var i=e.peers[t];if(i===o){e.peers.splice(t,1);break}}e.$digest()})}]),angular.module("p2pmusicApp").controller("ChatCtrl",["$scope","$rootScope",function(e,n){e.msgs=[{user:"chat",msg:"Welcome!"}],e.sendMessage=function(){mainChannel.send(e.message),e.msgs.push({user:"You",msg:e.message}),e.message=""},n.$on("rtc-onmessage",function(n,o){console.log(o),e.msgs.push(o),e.$digest()}),n.$on("rtc-onopen",function(n,o){e.msgs.push({user:"chat",msg:"user "+o+" joined."}),e.$digest()}),n.$on("rtc-onleave",function(n,o){e.msgs.push({user:"chat",msg:"user "+o+" left."}),e.$digest()})}]),angular.module("p2pmusicApp").controller("FiletransferCtrl",["$scope","$rootScope",function(e,n){e.transfers={},n.$on("rtc-onFileProgress",function(n,o){e.transfers[o.fileName]=o,e.$digest()}),n.$on("rtc-onFileSent",function(n,o){e.transfers[o.name].finished=!0,e.$digest()})}]),angular.module("p2pmusicApp").controller("FileBrowserCtrl",["$scope","$rootScope",function(e,n){e.show=!1,e.userid="",e.download=function(){mainChannel.channels[e.userid].send({requestFile:this.file})},e.stream=function(){console.log(this.file)},e.showLevel=function(e,n){if("number"==typeof n)return e.split("/")[n];if("string"==typeof n){var o=e.split("/");for(var t in o)if(o[t]===n)return o[t+1]}},e.$on("closeWindows",function(){console.log("closeMe"),e.show=!1}),n.$on("rtc-gotFileList",function(n,o){e.show=!0,e.userid=o.userid,e.files=o.files,e.$digest()})}]),angular.module("p2pmusicApp").controller("LoginCtrl",["$scope","$rootScope","RTCService","fileService",function(e,n,o,t){e.initialized=!1,e.usernameSet=!1,e.filesDropped=!1;var i=["De Jong","Jansen","De Vries","Van den Berg","Van Dijk","Bakker","Visser","Smit","Meijer","De Boer","Mulder","De Groot","Bos","Vos","Peters","Hendriks","Van Leeuwen","Dekker","Brouwer","De Wit","Dijkstra","Smits","De Graaf","Van der Meer"];e.username=i[Math.floor(Math.random()*i.length)],e.setUsername=function(){o.setupDataChannel(e.username),e.usernameSet=!0,e.username="",e.checkInit()},n.$on("file-Drop",function(n){console.log("drop"),t.dirRead(n,e.filesComplete),e.filesDropped=!0,e.checkInit(),e.$digest()}),e.filesComplete=function(){},e.checkInit=function(){e.filesDropped&&e.usernameSet&&(e.initialized=!0)}}]),angular.module("p2pmusicApp").controller("PlayerCtrl",["$scope","playerService",function(e){e.isPlaying=!1,e.togglePlaying=function(){e.isPlaying=!e.isPlaying}}]),angular.module("p2pmusicApp").factory("playerService",function(){if("webkitAudioContext"in window)var e=new webkitAudioContext;var n=function(n){console.log(n);var o=e.createBufferSource();e.decodeAudioData(n.data,function(n){o.buffer=e.createBuffer(n,!1),o.connect(e.destination),o.noteOn(0)})};return{context:e,bufferSound:n}}),angular.module("p2pmusicApp").directive("scrollBottom",function(){return{template:"",restrict:"A",link:function(e,n){e.$watch("msgs",function(){n.scrollTop(n.get(0).scrollHeight)},!0)}}}),angular.module("p2pmusicApp").controller("InterfaceCtrl",["$scope",function(e){e.broadcastClick=function(){e.$parent.$broadcast("interfaceClick")}}]),angular.module("p2pmusicApp").controller("WindowsCtrl",["$scope","$rootScope",function(e){e.keyDownHandler=function(){},e.broadcastClose=function(){console.log("closeWindows"),e.$broadcast("closeWindows")},e.$on("interfaceClick",e.broadcastClose),e.$on("click",e.broadcastClose),e.$on("keyDown",e.keyDownHandler)}]);